name: InvoiceChase CI/CD

# Automatic triggers commented out for safety
# on:
#   push:
#     branches:
#       - main
#   pull_request:

# Manual trigger for dev branch (or other branch you select)
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        default: 'dev'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
      API_KEYS_JSON: ${{ secrets.API_KEYS_JSON }}

    steps:
      # 1️⃣ Checkout the branch selected in the manual trigger
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # 3️⃣ Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4️⃣ Prepare keys folder and files
      - name: Prepare keys folder
        run: |
          mkdir -p keys
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON" > keys/firebase.json
          echo "$API_KEYS_JSON" > keys/keys.json

      # ------------------------
      # 5️⃣ Placeholder: Deploy to server via SSH
      # Safe and commented. Uncomment when ready.
      # ------------------------
      # - name: Deploy to server via SSH
      #   uses: easingthemes/ssh-deploy@v2
      #   with:
      #     SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
      #     REMOTE_HOST: ${{ secrets.SERVER_HOST }}
      #     REMOTE_USER: ${{ secrets.SERVER_USER }}
      #     TARGET: /path/to/deployment
      #     SOURCE: "."

      # ------------------------
      # 6️⃣ Placeholder: Start server
      # The uvicorn command will start your FastAPI app.
      # Commented to prevent accidental server restart.
      # ------------------------
      # - name: Start server
      #   run: |
      #     uvicorn main:app --host 0.0.0.0 --port 8000
